# Helios V3.0 - Higher Timeframe Aggregation Guide

**Date:** October 8, 2025
**Feature:** Multi-Timeframe Candle Aggregation
**Status:** ✅ OPERATIONAL

---

## Overview

Helios V3.0 generates candles across multiple timeframes to support different trading strategies and analysis requirements.

### Real-Time Auto-Generated Timeframes

**Location:** `src/data/streaming/live_candle_generator.py`

The LiveCandleGenerator automatically creates candles from WebSocket trade data in **real-time**:

- ✅ **1-minute (1m)** - Updated every minute
- ✅ **5-minute (5m)** - Updated every 5 minutes
- ✅ **15-minute (15m)** - Updated every 15 minutes

**Auto-Start:** These timeframes are generated automatically when the server starts (see `main.py` lines 110-149).

### Higher Timeframe Aggregation (Manual)

**Location:** `scripts/aggregate_higher_timeframes.py`

For longer-term analysis, higher timeframes are generated by **aggregating existing 1m candles** from the database:

- ⏱️ **1-hour (1h)** - Requires manual script execution
- ⏱️ **4-hour (4h)** - Requires manual script execution
- ⏱️ **1-day (1d)** - Requires manual script execution

**Why Separate?** Aggregating from 1m candles is more efficient than processing every trade for higher timeframes. This approach reduces computational load and database operations.

---

## Real-Time Timeframes (1m, 5m, 15m)

### How It Works

```
WebSocket Trades → LiveCandleGenerator → 1m/5m/15m Candles → Database (market_ohlc)
```

**Configuration:**

```python
# src/data/streaming/live_candle_generator.py (line 63)
self.timeframes = timeframes or ["1m", "5m", "15m"]
```

### Candle Structure

Each candle stored in `market_ohlc` table contains:

```sql
pair VARCHAR(20)           -- Trading pair (e.g., 'BTCZAR')
timeframe VARCHAR(10)      -- Timeframe ('1m', '5m', '15m')
open_time TIMESTAMP        -- Candle start time
close_time TIMESTAMP       -- Candle end time
open_price DECIMAL         -- Opening price
high_price DECIMAL         -- Highest price in period
low_price DECIMAL          -- Lowest price in period
close_price DECIMAL        -- Closing price
volume DECIMAL             -- Total volume
num_trades INTEGER         -- Number of trades
```

### Monitoring Real-Time Candles

Check latest candles:

```sql
SELECT pair, timeframe, open_time, close_time, close_price, volume
FROM market_ohlc
WHERE pair = 'BTCZAR' AND timeframe = '1m'
ORDER BY close_time DESC
LIMIT 10;
```

Expected: Candles within last 10 minutes.

---

## Higher Timeframes (1h, 4h, 1d)

### When to Use

Higher timeframes are useful for:

1. **Trend Analysis** - Long-term price movements
2. **Position Trading** - Multi-day strategies
3. **Backtesting** - Historical performance over weeks/months
4. **Portfolio Rebalancing** - Daily portfolio snapshots

### Aggregation Script

**Location:** `scripts/aggregate_higher_timeframes.py`

**Usage:**

```bash
# Aggregate all pairs for last 7 days (default)
python scripts/aggregate_higher_timeframes.py

# Aggregate specific pair for custom period
python scripts/aggregate_higher_timeframes.py --pairs BTCZAR --days 180

# Aggregate multiple pairs
python scripts/aggregate_higher_timeframes.py --pairs BTCZAR,ETHZAR --days 90
```

### What the Script Does

1. **Reads 1m candles** from `market_ohlc` table
2. **Groups by time period** (hourly, 4-hour, daily)
3. **Aggregates OHLCV data:**
   - Open: First candle's open price
   - High: Maximum high price
   - Low: Minimum low price
   - Close: Last candle's close price
   - Volume: Sum of all volumes
   - Num Trades: Sum of all trade counts
4. **Writes to `market_ohlc`** with appropriate timeframe label

### Aggregation Logic

**1-hour candles:**
```python
# Group 1m candles into 60-minute blocks
# 00:00 - 00:59 → 1h candle at 00:00
# 01:00 - 01:59 → 1h candle at 01:00
```

**4-hour candles:**
```python
# Group 1m candles into 240-minute blocks
# 00:00 - 03:59 → 4h candle at 00:00
# 04:00 - 07:59 → 4h candle at 04:00
```

**1-day candles:**
```python
# Group 1m candles into 24-hour blocks (UTC midnight to midnight)
# 2025-10-08 00:00 - 23:59 → 1d candle at 2025-10-08 00:00
```

### Example Output

```bash
$ python scripts/aggregate_higher_timeframes.py --pairs BTCZAR --days 7

================================================================================
  HELIOS V3.0 - HIGHER TIMEFRAME AGGREGATION
  Aggregates 1m candles to 5m, 15m, 1h, 4h, 1d
================================================================================

Configuration:
  Pairs: BTCZAR
  Lookback: 7 days
  Timeframes: 1h, 4h, 1d

Processing BTCZAR...

  [1h Aggregation]
    Source: 10,080 1m candles
    Created: 168 1h candles
    Stored: 168 candles

  [4h Aggregation]
    Source: 10,080 1m candles
    Created: 42 4h candles
    Stored: 42 candles

  [1d Aggregation]
    Source: 10,080 1m candles
    Created: 7 1d candles
    Stored: 7 candles

[SUCCESS] Aggregation complete for BTCZAR
  Total: 217 higher timeframe candles created
```

---

## Automation Options

### Option 1: Cron Job (Recommended for Production)

Run aggregation script hourly to keep higher timeframes up-to-date:

```bash
# Add to crontab (Linux/WSL)
crontab -e

# Add this line (runs every hour at :05 past the hour)
5 * * * * cd /path/to/helios && python scripts/aggregate_higher_timeframes.py --days 7 >> logs/aggregation.log 2>&1
```

### Option 2: Systemd Timer (Linux)

Create systemd service for scheduled aggregation:

```ini
# /etc/systemd/system/helios-aggregate.service
[Unit]
Description=Helios Higher Timeframe Aggregation

[Service]
Type=oneshot
User=helios
WorkingDirectory=/home/helios/helios-v3
ExecStart=/usr/bin/python3 scripts/aggregate_higher_timeframes.py --days 7

# /etc/systemd/system/helios-aggregate.timer
[Unit]
Description=Run Helios Aggregation Hourly

[Timer]
OnCalendar=hourly
Persistent=true

[Install]
WantedBy=timers.target
```

Enable:
```bash
sudo systemctl enable helios-aggregate.timer
sudo systemctl start helios-aggregate.timer
```

### Option 3: Manual Execution

Run script manually when needed:

```bash
# Before backtesting a strategy
python scripts/aggregate_higher_timeframes.py --pairs BTCZAR --days 180

# Daily portfolio review
python scripts/aggregate_higher_timeframes.py --days 30
```

---

## Database Storage

All timeframes (1m, 5m, 15m, 1h, 4h, 1d) are stored in the same `market_ohlc` table:

```sql
-- Query by timeframe
SELECT COUNT(*) FROM market_ohlc WHERE timeframe = '1h' AND pair = 'BTCZAR';

-- Get latest daily candle
SELECT * FROM market_ohlc
WHERE timeframe = '1d' AND pair = 'BTCZAR'
ORDER BY close_time DESC
LIMIT 1;

-- Compare volumes across timeframes
SELECT
    timeframe,
    AVG(volume) as avg_volume,
    COUNT(*) as candle_count
FROM market_ohlc
WHERE pair = 'BTCZAR' AND close_time > NOW() - INTERVAL '7 days'
GROUP BY timeframe
ORDER BY
    CASE timeframe
        WHEN '1m' THEN 1
        WHEN '5m' THEN 2
        WHEN '15m' THEN 3
        WHEN '1h' THEN 4
        WHEN '4h' THEN 5
        WHEN '1d' THEN 6
    END;
```

---

## Performance Considerations

### Real-Time Timeframes (1m, 5m, 15m)

**Pros:**
- ✅ Always up-to-date
- ✅ No manual intervention required
- ✅ Immediate availability after trade execution

**Cons:**
- ⚠️ Continuous database writes
- ⚠️ Higher CPU usage for trade aggregation

**Resource Usage:**
- CPU: ~5-10% (3 pairs, 3 timeframes)
- Memory: ~50-100 MB
- Database writes: ~3-15 inserts/minute

### Higher Timeframes (1h, 4h, 1d)

**Pros:**
- ✅ Efficient batch processing
- ✅ Lower database load (periodic vs continuous)
- ✅ Recomputes from source data (1m candles)

**Cons:**
- ⚠️ Requires periodic execution (manual or scheduled)
- ⚠️ Not real-time (delayed by aggregation interval)

**Resource Usage:**
- CPU: ~20-30% during aggregation (burst)
- Memory: ~100-200 MB (processes 7 days at once)
- Duration: ~30-60 seconds for 7 days × 3 pairs

---

## Use Cases by Timeframe

### 1-Minute (1m)
- **Use Case:** Scalping, high-frequency signals
- **Features:** 30 technical indicators
- **Trading Style:** Rapid entry/exit
- **Typical Hold Time:** Minutes to hours

### 5-Minute (5m)
- **Use Case:** Day trading, intraday momentum
- **Features:** 30 technical indicators
- **Trading Style:** Multiple trades per day
- **Typical Hold Time:** Hours

### 15-Minute (15m)
- **Use Case:** Swing trading signals, trend confirmation
- **Features:** 30 technical indicators
- **Trading Style:** Position management
- **Typical Hold Time:** Hours to days

### 1-Hour (1h)
- **Use Case:** Swing trading, trend analysis
- **Features:** Derived from 1m candles
- **Trading Style:** Multi-hour positions
- **Typical Hold Time:** Days

### 4-Hour (4h)
- **Use Case:** Position trading, major trend identification
- **Features:** Derived from 1m candles
- **Trading Style:** Multi-day positions
- **Typical Hold Time:** Days to weeks

### 1-Day (1d)
- **Use Case:** Long-term trend, portfolio rebalancing
- **Features:** Derived from 1m candles
- **Trading Style:** Buy-and-hold, strategic allocation
- **Typical Hold Time:** Weeks to months

---

## Backfilling Higher Timeframes

If you need historical higher timeframe data:

```bash
# Backfill 1h/4h/1d candles for last 6 months
python scripts/aggregate_higher_timeframes.py --pairs BTCZAR,ETHZAR,SOLZAR --days 180

# Verify candle counts
psql -U helios -d helios_v3 -c "
SELECT
    pair,
    timeframe,
    COUNT(*) as candle_count,
    MIN(open_time) as oldest,
    MAX(close_time) as newest
FROM market_ohlc
WHERE timeframe IN ('1h', '4h', '1d')
GROUP BY pair, timeframe
ORDER BY pair, timeframe;
"
```

**Expected Candle Counts (180 days):**
- 1h: ~4,320 candles (24 × 180)
- 4h: ~1,080 candles (6 × 180)
- 1d: ~180 candles (1 × 180)

---

## Troubleshooting

### Issue: No 1h/4h/1d candles in database

**Cause:** Aggregation script has not been run.

**Solution:**
```bash
python scripts/aggregate_higher_timeframes.py --pairs BTCZAR --days 7
```

### Issue: Higher timeframe candles are stale

**Cause:** Aggregation script not running on schedule.

**Solution:** Set up cron job or systemd timer (see Automation Options above).

### Issue: Aggregation script fails with "No 1m candles found"

**Cause:** Insufficient 1m candles in database.

**Solution:**
1. Ensure WebSocket is running: Check `main.py` auto-start logs
2. Run gap backfill: `python scripts/smart_gap_backfill.py`
3. Wait for 1m candles to accumulate, then retry aggregation

### Issue: Candle counts don't match expected (e.g., 4,320 for 180 days × 24 hours)

**Cause:** Gaps in 1m candle data (exchange downtime, system restarts).

**Solution:**
1. Run gap detection: `python scripts/smart_gap_backfill.py`
2. Re-run aggregation after gaps are filled

---

## Related Documentation

- **TIER1_AUTO_START.md** - Auto-start WebSocket data collection
- **smart_gap_backfill.py** - Detect and fill gaps in candle data
- **PHASE_1_COMPLETE.md** - Complete Phase 1 implementation guide
- **SETUP_GUIDE.md** - Quick start instructions

---

## Summary

**Real-Time Timeframes (Auto-Generated):**
- ✅ 1m, 5m, 15m
- ✅ Auto-start on server startup
- ✅ Always current, no manual intervention

**Higher Timeframes (Manual Aggregation):**
- ⏱️ 1h, 4h, 1d
- ⏱️ Run `scripts/aggregate_higher_timeframes.py`
- ⏱️ Recommended: Hourly cron job for automation

**Best Practice:**
```bash
# 1. Let server run for real-time 1m/5m/15m candles
python main.py

# 2. Schedule hourly aggregation for 1h/4h/1d (cron job)
5 * * * * cd /path/to/helios && python scripts/aggregate_higher_timeframes.py --days 7
```

---

**Last Updated:** October 8, 2025
**Status:** ✅ OPERATIONAL
